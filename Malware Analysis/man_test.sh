#!/bin/sh
ARG=$1
echo "Argument is $ARG"
logfile="logfile_$ARG.txt"
SAMPLE=`basename $2`
echo "Sample is $SAMPLE"
md5=$(echo "$SAMPLE"| grep -o "\-.\+$" | sed 's/-//' | head -1)


cd /home/ubuntu

# Make necessary directories
# sample should be in the home directory
if [ ! -d $ARG ];
then
	 mkdir $ARG
fi
if [ ! -d INCOMING/$ARG ];
then 
	mkdir INCOMING/$ARG
fi
if [ ! -d IOCS/$ARG ];
then
	mkdir IOCS/$ARG
fi

# mkdir INCOMING/$ARG
# mkdir PROCESSED
# mkdir IOCS
# mkdir IOCS/$ARG
# mkdir New_Samples
# mkdir Samples
# mkdir String.O
mv /home/ubuntu/New_Samples/$SAMPLE  /home/ubuntu/
echo "New Sample is $SAMPLE"
cp $SAMPLE IOCS/$ARG 
cp $SAMPLE INCOMING/$ARG
# mv exec_malware.sh IOCS
# cp snapshot_run.sh $ARG
# echo "Set up done"

find . -type f -name lockfile\* -exec rm {} \;
echo "Lockfiles have been removed"
# rm $ARG/portnum_check.txt
# echo "Portnumber has been reset"
rm $ARG/scp_progress.txt
echo "Removing and resetting progress"

echo "clearing caches done"
echo "Generating VTA-Output"
echo "Querying VirusTotal API" >> $logfile
python VT_Download.py $md5 -a $ARG
echo "Launching QEMU"
sh reduce_risk_test.sh $ARG $SAMPLE & 
# echo "Launching Logs"
# nohup xterm -title "Monitor output" -hold -e "tail -f logfile_$ARG.txt" &
sleep 1m 
echo "Launching SCP Process"
sh reduce_scp_risk.sh $ARG $SAMPLE &
echo "Beginning Execution"
sh bash_execute_test.sh $ARG &
mv $SAMPLE Samples
sh shutdown.sh $ARG
