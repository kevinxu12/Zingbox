#!/bin/sh
portfile="portnum_check.txt"
progress="scp_progress.txt"
shutdown_log="shutdown.txt"
cd /home/ubuntu/$1
if [ -f $portfile ];
then
	portnum=`cat $portfile`
	echo "The port number is $portnum"
fi

while [ ! -f $progress ];
do
	sleep 15s
	echo "progress not made" >> $shutdown_log
done

echo "progress made" >> $shutdown_log

cd /home/ubuntu/
nc=`python grab_nc_banner.py $portnum`
while [ $nc = "1" ];
do 
	sleep 15s
	nc=`python grab_nc_banner.py $portnum`
	echo "Qemu still open" >> $shutdown_log
done
echo "Qemu closed" >> $shutdown_log

echo "Now killing all as a backup"
sh shutdown_all.sh
