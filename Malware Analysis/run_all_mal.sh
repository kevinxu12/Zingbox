#!/bin/sh
ARG=$1
SAMPLE=$2
list_md5="md5.txt"

if grep -F "ONE" /home/ubuntu/IOCS/log_scp.txt;
then
	for filename in `cat /home/unbuntu/IOCS/log_scp.txt`; do
		cd /home/ubuntu/IOCS/
		echo "$filename"
		find . -name $filename -delete
	done
	echo "deleted all copied files"
	cd /home/ubuntu
	echo "now clearing log_scp.txt"
	> "/home/ubuntu/IOCS/log_scp.txt"
fi

if [[ $(ps -aux | grep run_all_mal | wc -l) -ge 2 ]];
then
	echo "another instance of run_all_mal is going"
	echo "now exiting"
	exit
fi

if [ -z "$1"];
then 
	echo "no pre-determined argument specified"
fi
# if no sample is specified, the script checks to see if md5s are listed
if [ -z "$2" ];
then
	echo "no pre determined sample specificied"
	# cd /home/ubuntu/New_Samples
	# if [ -f $list_md5 ]; then
        	# echo "md5 specifications found"
        	# while read p ; do
                	# echo "md5 is $p"
                	# cd /home/ubuntu
                	# python VT_Download.py $p
                	# echo "donwload is complete"
                	# filename="VTDL$p.danger"
                	# ./man_test.sh $ARG $filename
        	# done <$list_md5
        	# echo -n > $list_md5
        	# cd /home/ubuntu/New_Samples
        	# rm $list_md5
        	# cd /home/ubuntu
	# fi
	cd /home/ubuntu
	echo "checking if New_Samples is empty"
	if [ -z "$(ls -A /home/ubuntu/New_Samples)" ]; then
		echo "Empty"
	else
		echo "Not Empty"
		echo "now looping through"
		for filename in /home/ubuntu/New_Samples/*; do
                	name=${filename##*/}
                	ARG=$(echo "$name" | grep -o "[A-Z0-9\_]\+" | head -1)
                	echo "Argument is $ARG"
                	echo "file name is $name"
                	./man_test.sh $ARG $name
  		done
	fi
else
	cd /home/ubuntu/New_Samples
	if [ -f $2 ]; then
		echo "Pre-specified sample called"
		echo "Running manual test on the pre-specified sample"
		cd /home/ubuntu
		./man_test.sh $ARG $2
	fi
fi
