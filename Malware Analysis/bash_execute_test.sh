#!/bin/sh

portnum="$2"
progress="/home/ubuntu/$1/scp_progress.txt"
portfile='portnum_check.txt'
logfile="/home/ubuntu/logfile_$1.txt"

echo "Remote malware execution script starting at `date`" >> $logfile

cd $1

if [ -f $portfile ]; then
	portnum=`cat $portfile`
	echo "The port number is $portnum"
fi

# this portion is meant to make sure execute occurs only after SCP has occured
# the change involves moving the part in which progress is created
while [ ! -f $progress ];
do
	sleep 20s
	# echo "Sleep because progress has not been built yet"
done
echo "files have been scped over. now starting execute" >> $logfile

if [ -f $progress ]
then
        if [ `cat $progress`="waiting" ]
	then
		echo "Now executing malware in QEMU" >> $logfile
		sshpass -p "root" ssh -o StrictHostKeyChecking=no root@localhost -p $portnum /bin/bash < /home/ubuntu/IOCS/exec_malware.sh
	elif [ `cat $progress`="sent" ]
	then
		sleep 30    # wait 30 seconds
	        echo "Waited 30 seconds and trying to execute malware again" >> $logfile	
        	if [ `cat $progress`="waiting" ]; then
		# execute the malware remotely in QEMU
		sshpass -p "root" ssh -o StrictHostKeyChecking=no root@localhost -p $portnum /bin/bash < /home/ubuntu/IOCS/exec_malware.sh
        	fi
	else
                echo "Malware could not be executed" >| $progress
                echo "Malware could not be executed" >> $logfile
	fi
fi

cd ..
